# توثيق مشروع "طلبي" (Talabye)

مشروع **طلبي** هو منصة متقدمة للتسوق بالوكالة (Proxy Shopping) ودروبشيبينغ (Dropshipping)، يتيح للمستخدمين التسوق من منصات عالمية متعددة عبر واجهة واحدة، مع معالجة معقدة للبيانات والعملات واللوجستيات.

---

## ١. نبذة عن المشروع

يعمل النظام كوسيط ذكي بين العميل والمنصات العالمية (مثل Amazon، Trendyol، وغيرها). يقوم النظام بسحب بيانات المنتجات ديناميكياً، معالجة الأسعار وتحويلها للعملة المحلية، حساب تكاليف الشحن بناءً على الأوزان، وإدارة عملية الدفع والطلب حتى التوصيل.

---

## ٢. شرح الموديلات (Models)

يحتوي النظام على بنية بيانات متماسكة تربط بين المستخدمين، المنتجات، والطلبات:

### **المستخدم والتحقق (Auth & Users)**

- **`User`**: يمثل العميل، يحتوي على بياناته الأساسية، رموز الأجهزة للتنبيهات (`device_token`) وعلاقاته مع الطلبات والعناوين.
- **`Otp`**: مسؤول عن إدارة رموز التحقق لمرة واحدة، ويُستخدم لتأمين عمليات تسجيل الدخول عبر رقم الهاتف.
- **`Address`**: يخزن عناوين الشحن الخاصة بالمستخدمين، مع دعم الإحداثيات الجغرافية.

### **التواصل مع المنصات الخارجية (Platforms & Scraping)**

- **`Platform`**: يمثل المواقع الخارجية المدعومة. يحتوي على إعدادات العملة، واجهة الـ Scraper الخاصة بكل موقع، وحالة التفعيل.
- **`Product`**: يخزن بيانات المنتجات التي يتم سحبها أو استيرادها، بما في ذلك السعر، الوصف، والصور.
- **`CurrencyExchangeRate`**: يدير أسعار الصرف لتحويل العملات من المنصات العالمية إلى العملة المحلية (SAR/YER) عبر محور تحويل ثابت.

### **إدارة التسوق والطلبات (Shopping Context)**

- **`Cart`**: سلة تسوق مخصصة لكل مستخدم ولكل منصة بشكل منفصل. تدير ملخصات الأسعار والضرائب والشحن.
- **`CartItem`**: العناصر الفردية داخل سلة التسوق، مرتبطة بالمنتج والكمية.
- **`CheckoutOrder`**: يمثل عملية "الدفع" الكاملة. قد تحتوي عملية الدفع الواحدة على عدة طلبات من منصات مختلفة.
- **`Order`**: طلب محدد تابع لمنصة واحدة، مسجل ضمن `CheckoutOrder` أشمل.
- **`OrderItem`**: التفاصيل الدقيقة للمنتجات داخل الطلب الفردي.

### **أخرى (General)**

- **`Notification`**: سجل للتنبيهات المرسلة للمستخدمين (عبر FCM).
- **`Page`**: مخصص لإدارة محتوى الصفحات الثابتة (CMS) مثل "من نحن" أو "الشروط والأحكام".

---

## ٣. شرح معمق للنظام (Deep Dive)

### **أولاً: محرك السحب الذكي (The Scraper Module)**

قلب النظام هو `App\Modules\Scraper`. لا يقوم فقط بجلب HTML، بل:

1. **معالجة الأسعار**: تنظيف النصوص وتحويلها إلى أرقام عشرية مع مراعاة اختلاف الفواصل العشرية (نقطة أو فاصلة) حسب لغة المنصة.
2. **حقن السكربتات**: النظام يحقن سكربتات Javascript خاصة بكل منصة (`script_file`) في واجهات العرض لتمكين المستخدم من التفاعل المباشر مع المنصة الخارجية داخل التطبيق.

### **ثانياً: منطق تحويل العملات (Currency Logic)**

يعتمد النظام على صف (Service) `App\Services\Currency` الذي يستخدم الريال السعودي (SAR) كمحور مركزي (Pivot) للتحويل.

- يتم جلب السعر من المنصة (مثلاً بالليرة التركية).
- يتم تحويله للريال السعودي بناءً على أسعار الصرف المخزنة.
- يتم عرضه للمستخدم النهائي بالعملة المختارة (مثل اليمني YER).

### **ثالثاً: نظام الطلبات المتعدد (Multi-Order Workflow)**

عندما يقوم المستخدم بالدفع:

1. ينشئ النظام `CheckoutOrder` رئيسي يربط كل المنتجات المختارة.
2. يتم تقسيم العناصر بناءً على المنصة (Platform) إلى عدة سجلات `Order`.
3. كل `Order` يمر بدورة حياة مستقلة (شحن دولي، وصول للمخازن، شحن محلي).

### **رابعاً: اللوجستيات وحساب الأوزان (Weight & Shipping)**

يوجد قسم خاص لحساب تكاليف الشحن بناءً على الوزن (`App\Services\Weight`). النظام يأخذ في الحسبان:

- الشحن من المنصة الخارجية (Local Shipping).
- الشحن الدولي بناءً على وزن المنتج الفعلي.
- الضرائب (عادة 5%).

### **خامساً: البنية التحتية والاتصال**

- يستخدم النظام **Laravel Sanctum** لتأمين واجهات البرمجية (APIs).
- يعتمد على **Firebase (FCM)** لإرسال تنبيهات لحظية للمستخدمين عن حالة طلباتهم.
- يستخدم **Filament** كلوحة تحكم إدارية شاملة للتحكم في المنصات، مراجعة الطلبات، وتعديل أسعار الصرف.

---

_تم إنشاء هذا المستند آلياً لتوثيق هيكلية مشروع "طلبي"._
